ARG GO_VERSION=1.24
FROM golang:${GO_VERSION}-alpine AS build-playground
LABEL maintainer="soulteary@gmail.com"

# Enable module support
ENV GO111MODULE=on

# Create app directory
WORKDIR /go/src/playground

# Download Go dependencies
COPY src/go.mod src/go.sum ./
RUN go mod download

# Copy source and build binary
COPY ./src ./
RUN CGO_ENABLED=0 go build -ldflags="-w -s" -o /go/bin/playground .

# ------------------------------------------------
# Runtime image: install faketime stdlib + web UI
# ------------------------------------------------
FROM golang:${GO_VERSION}-alpine

# Copy custom Go runtime with built-in sandbox binary
COPY --from=build-playground /usr/local/go /usr/local/go-faketime

ENV CGO_ENABLED=0
ENV GOPATH=/go
ENV GOROOT=/usr/local/go-faketime
ARG GO_VERSION
ENV GO_VERSION=${GO_VERSION}
ENV PATH="/go/bin:/usr/local/go-faketime/bin:${PATH}"

# Compile Go standard library with faketime tag
WORKDIR /usr/local/go-faketime
RUN ./bin/go install --tags=faketime std && \
    ./bin/go vet --tags=faketime std || true

# Set up app runtime
RUN mkdir -p /app
COPY --from=build-playground /go/bin/playground /app/playground
COPY src/edit.html /app/
COPY src/static /app/static
COPY src/examples /app/examples

WORKDIR /app
EXPOSE 8080

ENTRYPOINT ["/app/playground"]
